<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fusion-Fit: Premium Protocol Interface</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Load Inter Font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; /* slate-950 */
            color: #e2e8f0; /* slate-200 */
            /* Subtle background texture for aesthetic */
            background-image: radial-gradient(circle, #0e1217 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* Custom scrollbar for aesthetic */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #f97316; /* orange-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #f59e0b; /* amber-500 */
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app-root" class="min-h-screen">
        <div class="flex items-center justify-center h-screen bg-slate-950">
            <div class="text-white flex flex-col items-center">
                <svg class="animate-spin h-8 w-8 text-orange-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="text-lg text-slate-400 font-medium">Initializing Protocol...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // ADDED: GoogleAuthProvider, signInWithPopup, linkWithPopup
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, linkWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables available inside this module script
        let app;
        let auth;
        let db;
        let userId = null;
        let isAuthReady = false;
        let activeTab = 'dashboard';
        let mobileMenuOpen = false;
        let weightChartInstance = null; // Track chart instance to prevent canvas errors
        let isAnonymousUser = false; // Track if the user is anonymous
        let profileMessage = ''; // Message state for the profile save/login process

        // --- GLOBAL STATE MANAGEMENT ---
        // 1. User Profile and Metrics State (from Firestore)
        let userState = {
            name: '',
            height: '',
            weight: '',
            age: '',
            goal: 'maintenance',
            goalDurationMonths: 0,
            targetWeightChangeKg: 0,
            weightHistory: [], 
            streakDays: 0,
            lastCompletionDate: null, 
            weeklyCompletion: {},
            dailyWaterIntake: 0,
            dailyWaterDate: null,
        };
        
        // 2. Coach Rex Chat State (Temporary, non-Firestore state for chat persistence across re-renders)
        let coachState = {
            messages: [],
            isThinking: false
        };

        // --- Global Constants and Utilities ---
        const FIREBASE_CONFIG = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-fusion-app';
        const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const WATER_GOAL_ML = 3000;
        const INCREMENT_ML = 1000;
        
        const getTodayDateString = () => new Date().toISOString().slice(0, 10);
        
        const dateDifferenceInDays = (date1, date2) => {
            if (!date1 || !date2) return -1;
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            d1.setHours(0, 0, 0, 0);
            d2.setHours(0, 0, 0, 0);

            const diffTime = d2.getTime() - d1.getTime();
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        };

        const calculateBMI = (heightCm, weightKg) => {
            const h = parseFloat(heightCm);
            const w = parseFloat(weightKg);

            if (isNaN(h) || isNaN(w) || h <= 0) return { bmi: 'N/A', status: 'Incomplete', color: 'text-slate-500' };
            const heightM = h / 100;
            const bmiValue = w / (heightM * heightM);
            const roundedBmi = bmiValue.toFixed(1);

            let status = 'Healthy';
            let color = 'text-lime-400';

            if (bmiValue < 18.5) {
                status = 'Underweight';
                color = 'text-sky-400';
            } else if (bmiValue >= 25 && bmiValue < 30) {
                status = 'Overweight';
                color = 'text-amber-400';
            } else if (bmiValue >= 30) {
                status = 'Obese';
                color = 'text-red-500';
            }

            return { bmi: roundedBmi, status, color };
        };
        
        const BASE_PLANS = {
            maintenance: {
                title: "Adaptive Fitness Protocol (Level 1)",
                description: "Balanced routine for overall health, functional strength, and consistency.",
                schedule: [
                    { day: "MON", focus: "Full Body Strength", exercises: ["Squats 3x10", "Bench Press 3x10", "Row 3x10", "Plank 3x60s"] },
                    { day: "TUE", focus: "Cardio & Core", exercises: ["30 min Run/Cycle", "Crunches 3x20", "Leg Raises 3x15"] },
                    { day: "WED", focus: "Rest/Active Recovery", exercises: ["Yoga or Light Walk (30 min)"] },
                    { day: "THU", focus: "Upper Body Hypertrophy", exercises: ["Overhead Press 3x10", "Pull-ups 3x8", "Bicep Curls 3x12"] },
                    { day: "FRI", focus: "Lower Body & HIIT", exercises: ["Deadlifts 3x8", "Lunges 3x10 (each)", "HIIT Sprints (15 min)"] },
                    { day: "SAT", focus: "Mobility & Skill", exercises: ["Stretching Routine", "Practice a new skill (e.g., Handstands)"] },
                    { day: "SUN", focus: "Rest/Recovery", exercises: ["Full Day Off", "Meal Prep"] },
                ]
            },
            loss: {
                title: "Metabolic Acceleration Protocol (Level 1)",
                description: "High-volume, high-intensity routine focused on fat burning and endurance.",
                schedule: [
                    { day: "MON", focus: "Full Body Circuit A", exercises: ["Goblet Squats 3x15", "Push-ups 3xMax", "Kettlebell Swings 3x15", "Burpees 3x10"] },
                    { day: "TUE", focus: "LISS Cardio", exercises: ["60 min Brisk Walk/Slow Jog (Zone 2)"] },
                    { day: "WED", focus: "Upper Body & Core", exercises: ["Incline Dumbbell Press 3x12", "Lat Pulldowns 3x12", "Russian Twists 3x20"] },
                    { day: "THU", focus: "Rest/Active Recovery", exercises: ["Foam Rolling & Stretching"] },
                    { day: "FRI", focus: "Full Body Circuit B", exercises: ["Step-ups 3x12 (each)", "Overhead Triceps Ext 3x12", "Cali Row 3x12", "Mountain Climbers 3x60s"] },
                    { day: "SAT", focus: "HIIT Session", exercises: ["Tabata: 20s work / 10s rest (4 rounds of 4 exercises)"] },
                    { day: "SUN", focus: "Rest/Recovery", exercises: ["Full Day Off", "Deep Tissue Massage"] },
                ]
            },
            gain: {
                title: "Hypertrophy & Strength Protocol (Level 1)",
                description: "Lower rep range, higher weight routine for muscle growth and power.",
                schedule: [
                    { day: "MON", focus: "PUSH: Chest, Shoulders, Triceps", exercises: ["Barbell Bench 3x6-8", "Shoulder Press 3x8", "Lateral Raises 3x12", "Triceps Pushdown 3x10"] },
                    { day: "TUE", focus: "PULL: Back, Biceps, Core", exercises: ["Barbell Rows 3x6-8", "Deadlift (Light) 3x8", "Hammer Curls 3x10", "Cable Crunches 3x15"] },
                    { day: "WED", focus: "Rest/Light Cardio", exercises: ["30 min Light Walk or Cycle"] },
                    { day: "THU", focus: "LEGS: Quads, Hamstrings, Calves", exercises: ["Barbell Squats 3x6-8", "Leg Press 3x10", "Hamstring Curls 3x10", "Calf Raises 3x15"] },
                    { day: "FRI", focus: "Upper Body Volume", exercises: ["Dumbbell Bench 4x10", "Seated Cable Row 4x10", "Face Pulls 4x15", "Bicep Curls 4x12"] },
                    { day: "SAT", focus: "Active Recovery", exercises: ["Mobility drills and light stretching."] },
                    { day: "SUN", focus: "Rest/Recovery", exercises: ["Full Day Off", "Refeed Day"] },
                ]
            }
        };

        const WORKOUT_PLANS = {
            maintenance: { title: "General Fitness Protocol" },
            loss: { title: "Metabolic Acceleration" },
            gain: { title: "Hypertrophy & Strength" }
        };

        const getDynamicSchedule = (goal, streakDays) => {
            const basePlan = BASE_PLANS[goal] || BASE_PLANS['maintenance'];
            const progressionLevel = Math.floor(streakDays / 14); 
            const currentWeek = `WEEK ${(Math.floor(streakDays / 7) % 4) + 1}`;
            
            let dynamicSchedule = JSON.parse(JSON.stringify(basePlan.schedule));
            
            if (progressionLevel > 0) {
                dynamicSchedule = dynamicSchedule.map(day => {
                    if (!day.focus.toLowerCase().includes("rest")) {
                        let newExercises = day.exercises.map(ex => {
                            if (ex.includes('x')) {
                                let [movement, setsReps] = ex.split(' ');
                                if (setsReps) {
                                    let [sets, reps] = setsReps.split('x').map(Number);
                                    
                                    const newSets = sets + Math.floor(progressionLevel / 2);
                                    const newReps = reps + (progressionLevel % 2);
                                    
                                    return `${movement} ${newSets}x${newReps}`;
                                }
                            }
                            return ex;
                        });
                        return { ...day, exercises: newExercises };
                    }
                    return day;
                });
            }

            return {
                ...basePlan,
                schedule: dynamicSchedule,
                progressionLevel: progressionLevel,
                currentWeek: currentWeek
            };
        };

        const getCoachResponse = (query, goal) => {
            const lowerQuery = query.toLowerCase();

            if (lowerQuery.includes('pace') || lowerQuery.includes('track') || lowerQuery.includes('goal pacing')) {
                let response;
                if (goal === 'loss') {
                    response = "STATUS: MONITORING. For **Weight Loss**, the target pace is typically $0.5$ - $1.0$ kg/week. Ensure your calorie deficit is consistent and prioritize protein intake to preserve muscle mass. Review your goal in the Profile tab.";
                } else if (goal === 'gain') {
                    response = "STATUS: OPTIMAL. For **Muscle Gain**, the recommended pace is $0.2$ - $0.5$ kg/week. Focus on progressive overload in your workouts and consume a surplus of $250$ - $500$ kcal daily.";
                } else {
                    response = "STATUS: MAINTENANCE. Your goal is general fitness. Focus on consistency, completing $4$ - $5$ workouts per week, and hitting your hydration goals. Keep up the streak!";
                }
                return `// PROTOCOL REX // ${response}`;
            }

            if (lowerQuery.includes('macro') || lowerQuery.includes('macro split')) {
                let response;
                if (goal === 'loss') {
                    response = "MACRO INSTRUCTION: Prioritize protein for satiety and muscle preservation. Aim for a split near **$40\%$ Protein / $30\%$ Fat / $30\%$ Carbs**. Adjust fat and carbs based on energy levels.";
                } else if (goal === 'gain') {
                    response = "MACRO INSTRUCTION: To fuel muscle growth, increase both protein and carbohydrates. Target a split of **$35\%$ Protein / $45\%$ Carbs / $20\%$ Fat**. Consume carbs pre and post-workout.";
                } else {
                    response = "MACRO INSTRUCTION: For general fitness, a balanced approach is best. Aim for **$30\%$ Protein / $40\%$ Carbs / $30\%$ Fat**. Adjust slightly based on your daily activity.";
                }
                return "// NUTRITION MATRIX // " + response;
            }

            if (lowerQuery.includes('sleep') || lowerQuery.includes('recovery') || lowerQuery.includes('sleep hygiene')) {
                return "// RECOVERY PROTOCOL // Initiate Sleep Hygiene Check: 1) **Maintain a consistent sleep schedule**. 2) **Dim ambient light** $60$ minutes before bed. 3) **Ensure your room temperature is cool**. Prioritize $7$ - $9$ hours.";
            }

            if (lowerQuery.includes('today') || lowerQuery.includes('workout plan')) {
                return "// PROTOCOL READY // Consult the 'Plan' tab for your **complete scheduled workout**. Ensure you hit your $3000$ml hydration target and maintain your streak. Execute with maximum efficiency.";
            }

            return "// DATA UNKNOWN // Query refined. Coach Rex needs more specific training or nutrition data. Try a Quick-Ask button or ask about a specific exercise or food.";
        };

        // --- Icon SVGs (Inline) ---
        const icons = {
            Home: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            User: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
            Dumbbell: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.4 14.4L9.6 9.6"/><path d="M18 10V6"/><path d="M14 6h4"/><path d="M10 18v-4"/><path d="M6 14h4"/><path d="M21 3l-3 3"/><path d="M3 21l3-3"/><path d="M15 9l-3 3"/><path d="M9 15l-3 3"/></svg>`,
            MessageSquare: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
            Menu: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>`,
            X: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
            Activity: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
            Award: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.4 3.4L21 6.8l-4.7 4.7L18.4 17l-6.4-3.4-6.4 3.4L7.7 11.5 3 6.8l5.6-1.4z"/></svg>`,
            TrendingUp: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>`,
            Target: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
            Droplet: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.32 0z"/></svg>`,
            Check: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
            CheckCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14 9 11"/></svg>`,
            Utensils: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v7c0 1.1 0.9 2 2 2h3c1.1 0 2-0.9 2-2V2"/><path d="M7 11v11"/><path d="M15 2v7c0 1.1.9 2 2 2h3c1.1 0 2-.9 2-2V2"/><path d="M19 11v11"/></svg>`,
            Clock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
            Send: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>`,
            Plus: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
            Google: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.343c-1.77,2.833-5.597,6.38-11.343,6.38 c-6.702,0-12.128-5.836-12.128-13c0-7.164,5.426-13,12.128-13c3.16,0,5.992,1.386,8.239,3.587L38.257,8.28 C34.821,4.195,29.742,2,24,2C11.839,2,2,11.901,2,24s9.839,22,22,22c11.758,0,16.89-4.175,18.428-9.356 c0.871-2.903,1.354-6.427,1.354-10.644C44,22.684,43.834,21.365,43.611,20.083z"/><path fill="#FF3D00" d="M6.307,14.691L4.824,9.608C8.891,4.557,15.176,2,24,2c5.742,0,10.821,2.195,14.257,5.856 L30.939,12.26C28.692,10.059,25.86,8.673,22.7,8.673c-6.702,0-12.128,5.836-12.128,13C10.572,28.836,16,34.672,22.7,34.672 c3.011,0,5.452-1.077,7.206-2.946l0.292,0.281C26.586,34.505,24,34.885,24,34.885c-12.161,0-21.999-9.837-21.999-22 C2.001,13.811,5.204,13.256,6.307,14.691z"/><path fill="#4CAF50" d="M44,24c0-4.217-0.483-7.741-1.354-10.644c-1.538-5.181-6.669-9.356-18.428-9.356 c-4.735,0-9.283,1.401-13.041,3.844l4.286,3.429C20.108,12.44,22.7,11.2,25.7,11.2c5.688,0,10.301,4.721,10.301,10.5 c0,5.779-4.722,10.5-10.41,10.5c-2.31,0-4.516-0.893-6.26-2.483l-3.238,3.238C15.827,38.805,19.749,41,24,41 c4.793,0,9.07-1.428,12.57-4.14C39.696,33.565,42.499,30.347,43.834,26.793C44.704,24.871,44,24,44,24z"/><path fill="#1976D2" d="M10.572,21.673c0-5.279,4.613-10.5,10.41-10.5c2.934,0,5.556,1.077,7.632,3.016l4.267-3.413 C32.716,9.489,28.279,8,24,8c-8.824,0-15.109,2.557-19.176,7.608l1.483,5.083C6.307,21.603,9.51,21.047,10.572,21.673z"/></svg>`,
        };

        // --- Core UI Components (HTML Templates) ---
        
        const NavButton = (id, label, iconKey) => `
            <button
                onclick="window.setActiveTab('${id}')"
                class="flex items-center gap-3 px-4 py-3 rounded-full transition-all duration-300 font-semibold text-sm 
                ${activeTab === id
                    ? 'bg-orange-600 text-slate-950 shadow-xl shadow-orange-500/30 ring-2 ring-orange-400/50'
                    : 'text-slate-400 hover:bg-slate-800 hover:text-orange-400'
                }"
            >
                <span class="w-5 h-5">${icons[iconKey]}</span>
                <span class="hidden lg:inline">${label}</span>
            </button>
        `;

        const Navigation = () => {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'Home' },
                { id: 'plan', label: 'Workout Plan', icon: 'Dumbbell' },
                { id: 'profile', label: 'Profile', icon: 'User' },
                { id: 'coach', label: 'Coach Rex', icon: 'MessageSquare' },
            ];

            const navButtons = navItems.map(item => NavButton(item.id, item.label, item.icon)).join('');
            const mobileButtons = navItems.map(item => `
                <button
                    onclick="window.setActiveTab('${item.id}'); window.setMobileMenu(false);"
                    class="flex items-center gap-3 px-4 py-3 rounded-full transition-all duration-300 font-semibold text-sm w-full
                    ${activeTab === item.id
                        ? 'bg-orange-600 text-slate-950 shadow-xl shadow-orange-500/30 ring-2 ring-orange-400/50'
                        : 'text-slate-400 hover:bg-slate-800 hover:text-orange-400'
                    }"
                >
                    <span class="w-5 h-5">${icons[item.icon]}</span>
                    <span>${item.label}</span>
                </button>
            `).join('');

            return `
                <header class="bg-slate-950/90 backdrop-blur-xl border-b border-slate-800 shadow-2xl sticky top-0 z-20">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center h-24">
                            <div class="flex items-center">
                                <h1 class="text-3xl font-extrabold text-white tracking-tighter flex items-center">
                                    <span class="w-9 h-9 mr-3 text-orange-500">${icons.Activity}</span>
                                    <span class="text-orange-500">FUSION</span><span class='text-slate-300'>-FIT</span>
                                </h1>
                            </div>

                            <!-- Desktop Navigation -->
                            <nav class="hidden sm:flex space-x-3">
                                ${navButtons}
                            </nav>

                            <!-- Mobile Menu Button -->
                            <button
                                class="sm:hidden text-orange-500 p-3 rounded-xl hover:bg-slate-800 transition"
                                onclick="window.setMobileMenu(${!mobileMenuOpen})"
                            >
                                <span class="w-7 h-7">${mobileMenuOpen ? icons.X : icons.Menu}</span>
                            </button>
                        </div>
                    </div>

                    <!-- Mobile Menu Dropdown -->
                    ${mobileMenuOpen ? `
                        <div class="sm:hidden px-4 pt-2 pb-4 space-y-2 bg-slate-950/95 absolute w-full shadow-2xl">
                            ${mobileButtons}
                        </div>
                    ` : ''}
                </header>
            `;
        };

        const GlassCard = (content, className = '', highlightColor = 'border-orange-500/30') => `
            <div class="bg-slate-900/80 backdrop-blur-xl rounded-[20px] p-8 border ${highlightColor} shadow-2xl shadow-slate-950/70 transition-all duration-500 ${className}">
                ${content}
            </div>
        `;

        const IconButton = (content, onClickHandler, color = 'orange', disabled = false, type = 'button') => {
            const baseClasses = "flex items-center justify-center px-6 py-3 rounded-xl font-bold transition-all duration-300 transform hover:scale-[1.03] disabled:opacity-50 uppercase tracking-widest shadow-lg focus:outline-none focus:ring-4 ring-offset-2 ring-offset-slate-950";
            let colorClasses;
            let currentBaseClasses = baseClasses;

            if (color === 'orange') {
                colorClasses = 'bg-orange-600 hover:bg-orange-500 text-slate-950 shadow-orange-500/50 ring-orange-500/50';
            } else if (color === 'lime') {
                colorClasses = 'bg-lime-600 hover:bg-lime-500 text-slate-950 shadow-lime-500/50 ring-lime-500/50';
            } else if (color === 'purple') {
                colorClasses = 'bg-purple-600 hover:bg-purple-500 text-white shadow-purple-500/50 ring-purple-500/50';
            } else if (color === 'small-lime') {
                currentBaseClasses = "flex items-center justify-center px-4 py-2 rounded-lg font-bold transition-all duration-200 transform hover:scale-[1.05] disabled:opacity-50 uppercase tracking-wide shadow-md focus:outline-none focus:ring-2 ring-offset-1 ring-offset-slate-950 text-xs";
                colorClasses = 'bg-lime-600 hover:bg-lime-500 text-slate-950 shadow-lime-500/30 ring-lime-500/50';
            } else if (color === 'google') {
                 colorClasses = 'bg-white hover:bg-slate-100 text-slate-950 shadow-slate-500/30 ring-slate-400/50';
            }

            return `
                <button
                    type="${type}"
                    onclick="${onClickHandler}"
                    ${disabled ? 'disabled' : ''}
                    class="${currentBaseClasses} ${colorClasses}"
                >
                    ${content}
                </button>
            `;
        };
        
        const CircleIconButton = (iconSvg, onClickHandler, disabled = false) => {
            const sizeClasses = 'w-14 h-14 text-lg';
            const colorClasses = 'bg-sky-600 hover:bg-sky-500 text-slate-950 shadow-2xl shadow-sky-500/50 ring-4 ring-sky-500/50';

            const baseClasses = `flex items-center justify-center rounded-full font-extrabold transition-all duration-300 transform hover:scale-110 disabled:opacity-50 focus:outline-none ring-offset-2 ring-offset-slate-950 ${sizeClasses}`;

            return `
                <button
                    onclick="${onClickHandler}"
                    ${disabled ? 'disabled' : ''}
                    class="${baseClasses} ${colorClasses}"
                >
                    <span class="w-6 h-6">${iconSvg}</span>
                </button>
            `;
        };
        
        // --- Page Renderers ---

        const renderDashboard = () => {
            const user = userState;
            const { bmi, status: bmiStatus, color: bmiColor } = calculateBMI(user.height, user.weight);
            
            const completedSegments = Math.floor(user.dailyWaterIntake / INCREMENT_ML);
            const streakMessage = user.streakDays > 0 
                ? `Maintain your consistency. Streak at ${user.streakDays} days.` 
                : "Initialize your first data cycle by completing a workout.";
            
            // Helper for standard data pills
            const DataPill = (label, value, iconKey, colorClass, highlight, bmiStatus) => `
                <div class="p-5 rounded-2xl border-b-4 border-l-2 ${highlight} bg-slate-800/80 shadow-inner shadow-slate-950/50 flex flex-col justify-between h-full overflow-hidden">
                    <div class="flex items-center justify-between mb-1">
                        <p class="text-xs text-slate-400 uppercase font-medium tracking-widest">${label}</p>
                        <span class="w-5 h-5 ${colorClass}">${icons[iconKey]}</span>
                    </div>
                    <div>
                        <span class="text-4xl font-extrabold mt-1 block ${colorClass} break-all">${value}</span>
                        ${bmiStatus ? `<span class="text-sm mt-1 block ${bmiColor} font-semibold break-words">${bmiStatus}</span>` : ''}
                    </div>
                </div>
            `;

            // New Chart Card Component (Integrated)
            const ChartCard = () => `
                <div class="col-span-2 sm:col-span-1 p-5 rounded-2xl border-b-4 border-l-2 border-sky-500/50 bg-slate-800/80 shadow-inner shadow-slate-950/50 relative overflow-hidden">
                    <div class="flex items-center justify-between mb-2 relative z-10">
                        <p class="text-xs text-slate-400 uppercase font-medium tracking-widest">Mass Vector</p>
                        <span class="w-5 h-5 text-sky-400">${icons.TrendingUp}</span>
                    </div>
                    <div class="flex items-end gap-2 relative z-10 mb-2">
                        <span class="text-4xl font-extrabold text-sky-400">${user.weight || 'N/A'}</span>
                        <span class="text-sm text-slate-500 font-mono mb-1">KG</span>
                    </div>
                    <!-- Canvas Container -->
                    <div class="h-16 w-full mt-2">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>
            `;
            
            const SegmentedProgressBar = (segments) => {
                let segmentsHtml = '';
                for (let i = 1; i <= 3; i++) {
                    const isFilled = i <= segments;
                    segmentsHtml += `
                        <div class="flex-1 h-5 rounded-lg transition-all duration-700 shadow-inner border border-slate-600 ${
                            isFilled ? 'bg-sky-500 shadow-sky-950' : 'bg-slate-700 shadow-slate-950/50'
                        }"></div>`;
                }
                return `<div class="flex space-x-2 w-full">${segmentsHtml}</div>`;
            };

            return `
                <div class="space-y-12 animate-fadeIn">
                    <!-- Hero Section -->
                    ${GlassCard(`
                        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center">
                            <div class="mb-4 lg:mb-0 max-w-full">
                                <h2 class="text-4xl sm:text-5xl font-extrabold text-white mb-2 break-words">
                                    PROTOCOL ONLINE, <span class="text-orange-500">${user.name || 'Athlete'}</span>
                                </h2>
                                <p class="text-lg text-slate-300 font-light mb-8 break-words">
                                    ${streakMessage} <span class="text-lime-400 ml-1 font-mono tracking-wider break-all">[${WORKOUT_PLANS[user.goal]?.title || 'N/A'}]</span>
                                </p>
                            </div>
                            ${IconButton(`<span class="w-5 h-5 mr-2">${icons.Dumbbell}</span> EXECUTE WORKOUT`, `window.setActiveTab('plan')`, 'orange')}
                        </div>
                    `, '!p-12 border-b-4 border-r-2 border-orange-500/70')}

                    <!-- Metrics Grid with Chart -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        ${DataPill("Active Streak", user.streakDays, "Award", "text-orange-400", "border-orange-500/50")}
                        ${ChartCard()} <!-- Chart.js Sparkline -->
                        ${DataPill("Primary Goal", WORKOUT_PLANS[user.goal]?.title.split(' ')[0] || 'N/A', "Target", "text-purple-400", "border-purple-500/50")}
                        ${DataPill("BMI Index", bmi, "Activity", bmiColor, "border-slate-500/50", bmiStatus)}
                    </div>
                    
                    <!-- Action Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        ${GlassCard(`
                            <div>
                                <h3 class="text-3xl font-extrabold text-white mb-2 uppercase tracking-wider">Hydration Matrix</h3>
                                <p class="text-sm text-slate-400 mb-6">Target: ${WATER_GOAL_ML} ML (3 x ${INCREMENT_ML}ML Segments)</p>
                                <div class="flex items-center justify-between mb-6">
                                    <p class="text-5xl font-extrabold text-sky-300 font-mono">${user.dailyWaterIntake} <span class="text-lg text-slate-400">ML</span></p>
                                    ${CircleIconButton(icons.Droplet, 'window.handleWaterIncrement()', completedSegments >= 3)}
                                </div>
                            </div>
                            ${SegmentedProgressBar(completedSegments)}
                            <p class="text-sm font-semibold uppercase tracking-widest mt-6 ${completedSegments >= 3 ? 'text-lime-400' : 'text-sky-400'}">
                                ${completedSegments >= 3 ? 'Goal Achieved' : `Log ${INCREMENT_ML} ML Increment (${completedSegments}/3)`}
                            </p>
                        `, 'flex flex-col justify-between', 'border-sky-500/50')}

                        ${GlassCard(`
                            <div>
                                <span class="w-9 h-9 text-purple-400 mb-4 inline-block">${icons.MessageSquare}</span>
                                <h3 class="text-3xl font-extrabold text-white mb-2 uppercase tracking-wider">Coach Rex AI</h3>
                                <p class="text-purple-300 mb-6">Access real-time protocol adjustments and personalized intelligence.</p>
                            </div>
                            ${IconButton(`<span class="w-5 h-5 mr-2">${icons.MessageSquare}</span> ACTIVATE ASSISTANT`, `window.setActiveTab('coach')`, 'purple')}
                        `, 'flex flex-col justify-between', 'border-purple-500/50')}
                    </div>
                </div>
            `;
        };

        const renderProfile = () => {
            const user = userState;
            const profileGoal = user.goal || 'maintenance';

            const InputField = (label, id, value, type = 'text', unit = '') => `
                <div class="flex flex-col space-y-2">
                    <label for="${id}" class="text-xs font-bold text-slate-400 uppercase tracking-widest">${label}</label>
                    <div class="flex items-center bg-slate-800/70 rounded-xl border border-slate-700 focus-within:ring-2 focus-within:ring-orange-500 transition-all shadow-inner shadow-slate-950/50">
                        <input
                            type="${type}"
                            id="${id}"
                            value="${value || ''}"
                            class="flex-1 bg-transparent p-3 text-white focus:outline-none placeholder-slate-600"
                            placeholder="Enter ${label.toLowerCase()}"
                            ${type === 'number' ? 'step="0.1"' : ''}
                        />
                        ${unit ? `<span class="text-slate-400 pr-4 font-mono">${unit}</span>` : ''}
                    </div>
                </div>
            `;

            const GoalSelector = (currentGoal) => `
                <div class="flex flex-col space-y-3">
                    <label class="text-sm font-bold text-slate-300 uppercase tracking-widest border-l-4 border-orange-500 pl-3">Primary Goal Protocol</label>
                    <div class="grid grid-cols-3 gap-4">
                        ${['loss', 'maintenance', 'gain'].map(g => {
                            // Logic to replace 'maintenance' display text with 'MAINTAIN'
                            const displayText = g === 'maintenance' ? 'MAINTAIN' : g.toUpperCase();
                            return `
                            <button
                                type="button"
                                onclick="window.setGoal('${g}')"
                                class="p-3 rounded-xl font-bold uppercase transition-all duration-200 text-xs shadow-lg ${
                                    currentGoal === g
                                        ? 'bg-orange-600 text-slate-950 ring-2 ring-orange-500/50 shadow-orange-500/50'
                                        : 'bg-slate-800 text-slate-300 hover:bg-slate-700/80 border border-slate-700'
                                }"
                            >
                                ${displayText}
                            </button>
                        `}).join('')}
                    </div>
                </div>
            `;

            // Display message based on profileMessage state
            const messageContent = profileMessage 
                ? `<p class="font-bold mt-4 text-sm ${profileMessage.includes('Error') ? 'text-red-400' : 'text-lime-400'}">${profileMessage}</p>`
                : '';
            
            // Login/Upgrade Section
            const authStatusSection = isAnonymousUser ? `
                <div class="border-t border-slate-700 pt-8 mt-10">
                    <h3 class="text-xl font-extrabold text-red-400 mb-4 uppercase tracking-wider flex items-center gap-3">
                        <span class="w-6 h-6">${icons.X}</span>
                        Upgrade Account Required
                    </h3>
                    <p class="text-sm text-slate-400 mb-6">Your current session is anonymous and data is temporary. Sign in with Google to secure your progress and sync across devices.</p>
                    
                    ${IconButton(`
                        <span class="w-5 h-5 mr-2">${icons.Google}</span> SIGN IN WITH GOOGLE
                    `, `window.handleGoogleSignIn()`, 'google', !isAuthReady || !userId)}
                </div>
            ` : `
                <div class="border-t border-lime-700 pt-8 mt-10">
                    <h3 class="text-xl font-extrabold text-lime-400 mb-4 uppercase tracking-wider flex items-center gap-3">
                        <span class="w-6 h-6">${icons.CheckCircle}</span>
                        Account Secured
                    </h3>
                    <p class="text-sm text-slate-400">Your profile is linked to a permanent account and backed up securely.</p>
                </div>
            `;


            return GlassCard(`
                <h2 class="text-3xl font-extrabold text-white mb-8 uppercase tracking-wider border-b border-slate-700 pb-4 flex items-center gap-3">
                    <span class="w-8 h-8 text-orange-500">${icons.User}</span>
                    Athlete Profile Calibration
                </h2>
                
                <div class="text-sm text-slate-400 mb-8 font-mono break-all p-4 bg-slate-800 rounded-lg border border-slate-700">
                    <span class="text-xs text-orange-400 block mb-1 uppercase tracking-widest">User Identifier:</span>
                    <span class="font-semibold">${userId || 'Authenticating...'}</span>
                </div>

                <form onsubmit="window.handleSaveProfile(event)" id="profile-form" class="space-y-10">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${InputField("Name", "profile-name", user.name)}
                        ${InputField("Age", "profile-age", user.age, "number")}
                        ${InputField("Height", "profile-height", user.height, "number", "cm")}
                        ${InputField("Weight", "profile-weight", user.weight, "number", "kg")}
                    </div>

                    <div class="border-t border-slate-700 pt-8">
                        ${GoalSelector(profileGoal)}
                    </div>

                    ${profileGoal !== 'maintenance' ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2">
                            ${InputField("Target Change", "profile-target-change", user.targetWeightChangeKg, "number", "kg")}
                            ${InputField("Duration", "profile-duration", user.goalDurationMonths, "number", "months")}
                        </div>
                    ` : ''}
                    
                    <div class="flex flex-col items-center">
                        ${IconButton(`
                            <span class="w-5 h-5 mr-2" id="save-icon">${icons.CheckCircle}</span> 
                            <span id="save-text">SAVE PROTOCOL</span>
                        `, `window.handleSaveProfile(event)`, 'orange', !isAuthReady || !userId, 'submit')}
                        <div id="profile-save-message">${messageContent}</div>
                    </div>
                </form>

                <!-- NEW LOGIN/UPGRADE SECTION -->
                ${authStatusSection}
                
            `, 'max-w-4xl mx-auto', 'border-orange-500/50');
        };

        const renderPlan = () => {
            const user = userState;
            const today = new Date();
            const dayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1; 
            const dayNames = ["MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN"];
            const schedule = getDynamicSchedule(user.goal, user.streakDays);

            const daysHtml = schedule.schedule.map((day, index) => {
                const isCurrentDay = index === dayIndex;
                const isCompleted = user.weeklyCompletion[index] === true;
                
                const baseGlassClasses = 'p-6 rounded-2xl transition-all duration-300 shadow-xl backdrop-blur-xl border-2 flex flex-col justify-between';

                let dynamicClasses = '';
                let titleColor = 'text-orange-400';
                let iconColor = 'text-slate-500';
                let listColor = 'text-slate-400';

                if (isCurrentDay) {
                    dynamicClasses = 'bg-slate-900/90 border-orange-500 ring-4 ring-orange-500/30 scale-[1.03] shadow-[0_0_25px_rgba(251,146,60,0.7)] z-10';
                    titleColor = 'text-orange-300';
                    iconColor = 'text-orange-400';
                    listColor = 'text-slate-200';
                } else if (isCompleted) {
                    dynamicClasses = 'bg-slate-800/70 border-lime-500/50 hover:bg-slate-700/70 shadow-inner shadow-lime-950/20';
                    titleColor = 'text-lime-400';
                    iconColor = 'text-lime-400';
                    listColor = 'text-lime-200';
                } else {
                    dynamicClasses = 'bg-slate-900/50 border-slate-800 hover:bg-slate-800/70 shadow-2xl shadow-slate-950/70';
                    titleColor = 'text-white';
                    iconColor = 'text-orange-500/50';
                    listColor = 'text-slate-400';
                }

                const cardClasses = `${baseGlassClasses} ${dynamicClasses}`;

                const exercisesHtml = day.exercises.map((ex) => `
                    <li class="flex items-start text-sm font-mono break-words">
                        <span class="text-[8px] mr-2 mt-[6px] ${listColor}">&#9679;</span> <span class="${listColor}">${ex}</span>
                    </li>
                `).join('');

                const button = isCompleted ? `
                    <button 
                        disabled
                        class="w-full flex items-center justify-center px-4 py-2 rounded-lg font-bold text-xs uppercase tracking-wide bg-lime-600/30 text-lime-400 border border-lime-600/50"
                    >
                        <span class="w-4 h-4 mr-1">${icons.Check}</span> PROTOCOL LOGGED
                    </button>
                ` : IconButton(`
                    LOG COMPLETE
                `, `window.handleCompleteDay(${index})`, 'small-lime', !isCurrentDay);


                return `
                    <div class="${cardClasses}">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-2xl font-black ${titleColor}">${day.day}</h3>
                                <span class="w-6 h-6 ${iconColor}">${isCompleted ? icons.CheckCircle : icons.Clock}</span>
                            </div>
                            <p class="font-semibold text-base ${isCurrentDay ? 'text-white' : 'text-slate-300'} break-words">${day.focus}</p>
                            
                            <ul class="list-none mt-4 space-y-2 text-sm">
                                ${exercisesHtml}
                            </ul>
                        </div>

                        <div class="mt-6">
                            ${button}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="space-y-10 animate-fadeIn">
                    ${GlassCard(`
                        <h2 class="text-3xl font-extrabold text-white mb-2 uppercase tracking-wider flex items-center gap-3">
                            <span class="w-8 h-8 text-orange-500">${icons.Dumbbell}</span>
                            ${schedule.title}
                        </h2>
                        <p class="text-slate-400 mb-6 break-words">${schedule.description}</p>
                        
                        <div class="flex flex-wrap items-center justify-between bg-slate-800/70 p-4 rounded-xl border border-slate-700 shadow-inner shadow-slate-950/50">
                            <div class="text-lg font-bold text-orange-400 break-words">
                                ${schedule.currentWeek} | INTENSITY: <span class="text-lime-400">${schedule.progressionLevel + 1}</span>
                            </div>
                            <div class="text-sm font-mono text-slate-300">
                                Base Goal: <span class="uppercase text-orange-400">${user.goal}</span>
                            </div>
                        </div>
                    `, '', 'border-orange-500/70')}

                    <!-- Daily Schedule Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${daysHtml}
                    </div>
                </div>
            `;
        };

        const renderCoach = () => {
            // REX FIX: Read state directly from global coachState
            const user = userState;
            const { messages, isThinking } = coachState; 

            const parseTextWithMarkdown = (text) => {
                // Simple bold markdown **text** to <strong>
                const parts = text.split(/(\*\*.*?\*\*)/g).map(part => {
                    if (part.startsWith('**') && part.endsWith('**')) {
                        return `<strong class="text-orange-300 font-extrabold">${part.slice(2, -2)}</strong>`;
                    }
                    return part;
                }).join('');
                // Use break-words in addition to whitespace-pre-wrap to handle extremely long URLs or tokens inside responses
                return parts.replace(/\n/g, '<br/>');
            };

            const messagesHtml = messages.map(msg => `
                <div class="flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[90%] md:max-w-[70%] px-5 py-3 rounded-xl text-sm transition-all duration-300 whitespace-pre-wrap break-words ${
                        msg.sender === 'user' 
                        ? 'bg-orange-600 text-slate-950 rounded-br-none font-semibold shadow-xl shadow-orange-500/30' 
                        : 'bg-slate-700 text-slate-100 rounded-tl-none border border-purple-500/30 font-mono shadow-xl shadow-purple-950/50'
                    }">
                        ${parseTextWithMarkdown(msg.text)}
                    </div>
                </div>
            `).join('');
            
            const QUICK_ASK_BUTTONS = [
                { text: "Today's Macros?", query: "What should my macro split be today?" },
                { text: "Goal Pacing?", query: "Am I on track for my weight goal?" },
                { text: "Sleep Advice", query: "Give me 3 tips for better sleep hygiene." },
                { text: "Today's Plan", query: "What is my workout plan for today?" },
            ];

            const quickAskButtonsHtml = QUICK_ASK_BUTTONS.map(item => `
                <button
                    onclick="window.handleQuickAsk('${item.query}')"
                    ${isThinking ? 'disabled' : ''}
                    class="flex items-center gap-1 px-3 py-2 text-xs font-semibold rounded-full bg-purple-600/30 border border-purple-600 text-purple-200 hover:bg-purple-600 hover:text-white transition-all duration-200 shadow-md whitespace-nowrap disabled:opacity-50"
                >
                    ${item.text}
                </button>
            `).join('');

            return GlassCard(`
                <div id="coach-container" class="h-[calc(100vh-8rem)] flex flex-col !p-0 overflow-hidden">
                    <!-- Header -->
                    <div class="p-5 bg-slate-800 border-b-4 border-purple-600/50 flex items-center gap-4 shadow-xl shadow-slate-950/70">
                        <div class="w-12 h-12 rounded-full bg-purple-600 flex items-center justify-center shadow-lg shadow-purple-500/50">
                            <span class="text-white w-6 h-6">${icons.MessageSquare}</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white uppercase tracking-widest">Coach Rex Protocol</h3>
                            <p class="text-xs text-lime-400 flex items-center gap-1 font-mono">
                                <span class="w-2 h-2 rounded-full bg-lime-400 ${isThinking ? 'animate-pulse' : ''}"></span> SYSTEM STATUS: ONLINE
                            </p>
                        </div>
                    </div>

                    <!-- Messages Area -->
                    <div id="coach-messages-area" class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-950/80 border-b border-slate-800">
                        ${messagesHtml}
                        ${isThinking ? `
                            <div class="flex justify-start">
                                <div class="max-w-[70%] px-5 py-3 rounded-xl bg-slate-700 text-slate-400 rounded-tl-none border border-purple-500/30 font-mono text-sm">
                                    <span class="animate-pulse">Analyzing protocol...</span>
                                </div>
                            </div>
                        ` : ''}
                        <div id="messages-end-ref"></div>
                    </div>
                    
                    <!-- Quick-Ask Buttons (DISABLED BY isThinking) -->
                    <div class="p-4 bg-slate-800/70 border-t border-slate-700 flex flex-wrap justify-start gap-3 overflow-x-auto">
                        ${quickAskButtonsHtml}
                    </div>

                    <!-- Input Form -->
                    <form onsubmit="window.handleSendCoach(event)" id="coach-form" class="p-4 bg-slate-800 border-t border-slate-700 flex gap-3">
                        <input 
                            type="text" 
                            id="coach-input"
                            placeholder="Input command..." 
                            class="flex-1 bg-slate-900 border border-slate-700 rounded-full px-5 py-3 text-white placeholder-slate-600 focus:ring-2 focus:ring-purple-500 focus:outline-none transition-shadow shadow-inner shadow-slate-950/50"
                            ${isThinking ? 'disabled' : ''}
                        />
                        <button 
                            type="submit" 
                            id="coach-send-btn"
                            class="bg-purple-600 hover:bg-purple-500 text-white rounded-full p-3 transition-all duration-200 transform hover:scale-105 disabled:opacity-50 shadow-lg shadow-purple-500/50"
                            disabled
                            ${isThinking ? 'disabled' : ''}
                        >
                            <span class="w-5 h-5">${icons.Send}</span>
                        </button>
                    </form>
                </div>
            `, 'h-full !p-0 overflow-hidden', 'border-purple-500/50');
        };
        
        // --- Chart.js Rendering Logic ---
        
        const renderWeightChart = () => {
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;

            // Destroy previous instance to prevent "canvas reuse" errors
            if (weightChartInstance) {
                weightChartInstance.destroy();
            }

            // Default history to today if empty, to ensure chart has at least one point
            const history = userState.weightHistory && userState.weightHistory.length > 0 
                ? userState.weightHistory 
                : [{ date: getTodayDateString(), weight: parseFloat(userState.weight) || 0 }];

            // Sort by date just in case
            history.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Take only the last 7 entries for the sparkline visual
            const recentHistory = history.slice(-7);

            const dataPoints = recentHistory.map(h => h.weight);
            const labels = recentHistory.map(h => h.date.slice(5)); // Show MM-DD

            weightChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataPoints,
                        borderColor: '#38bdf8', // sky-400
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#0f172a', // slate-900
                        pointBorderColor: '#38bdf8',
                        pointRadius: 4,
                        tension: 0.4, // Smooth curves
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: true, intersect: false, mode: 'index' } },
                    scales: {
                        x: { display: false }, // Hide X axis
                        // Hide Y axis but ensure line doesn't hit top/bottom edges
                        y: { display: false, min: Math.min(...dataPoints) - 2, max: Math.max(...dataPoints) + 2 } 
                    }
                }
            });
        };

        const renderContent = (tab) => {
            let content = '';
            switch (tab) {
                case 'dashboard': content = renderDashboard(); break;
                case 'profile': content = renderProfile(); break;
                case 'plan': content = renderPlan(); break;
                case 'coach': content = renderCoach(); break;
                default: content = renderDashboard(); break;
            }

            document.querySelector('main').innerHTML = content;
            
            // Chart.js Trigger: Only when dashboard is active
            if (tab === 'dashboard') {
                // Timeout needed to wait for innerHTML paint
                setTimeout(() => renderWeightChart(), 50);
            }
            
            // Special handling for Coach chat scroll and input listener
            if (tab === 'coach') {
                const messagesEndRef = document.getElementById('messages-end-ref');
                messagesEndRef?.scrollIntoView({ behavior: "smooth" });

                const inputEl = document.getElementById('coach-input');
                const sendBtn = document.getElementById('coach-send-btn');
                
                // REX FIX: Re-attach listener and set initial button state based on input value and thinking state
                if (inputEl && sendBtn) {
                    const updateSendButtonState = () => {
                        // Button is disabled if Coach is thinking OR input is empty
                        sendBtn.disabled = coachState.isThinking || !inputEl.value.trim();
                    };
                    
                    inputEl.addEventListener('input', updateSendButtonState);
                    updateSendButtonState(); // Set initial state
                }
            }
        };

        const renderApp = () => {
            const appRoot = document.getElementById('app-root');
            if (!isAuthReady) {
                appRoot.innerHTML = `
                    <div class="flex items-center justify-center h-screen bg-slate-950">
                        <div class="text-white flex flex-col items-center">
                            <svg class="animate-spin h-8 w-8 text-orange-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <p class="text-lg text-slate-400 font-medium">Authenticating Protocol...</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Main structure rendering
            appRoot.innerHTML = `
                ${Navigation()}
                <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
                    <!-- Content will be rendered here -->
                </main>
            `;
            
            // Render the content of the active tab
            renderContent(activeTab);
        };

        // --- Global Handlers (exposed to window for onclick) ---
        
        const setProfileMessage = (message) => {
            profileMessage = message;
            renderApp();
            // Clear message after 3 seconds
            setTimeout(() => {
                profileMessage = '';
                renderApp();
            }, 3000);
        }

        window.setActiveTab = (tab) => {
            activeTab = tab;
            // Close mobile menu when a tab is selected
            if (mobileMenuOpen) {
                setMobileMenu(false);
            } else {
                renderApp();
            }
        };
        
        window.setMobileMenu = (isOpen) => {
            mobileMenuOpen = isOpen;
            renderApp();
        };

        window.setGoal = (newGoal) => {
            userState.goal = newGoal;
            renderApp(); // Re-render profile page to update goal-specific inputs
        };
        
        window.handleWaterIncrement = async () => {
            if (!db || !userId) return;

            const todayDate = getTodayDateString();
            const streakRef = doc(db, 'artifacts', APP_ID, 'users', userId, 'completion_data', 'streak_stats');
            
            let currentIntake = userState.dailyWaterIntake;
            let intakeDate = userState.dailyWaterDate;
            
            // Check for new day and reset if needed
            if (intakeDate !== today) {
                currentIntake = 0;
            }
            
            // Calculate the next intake, capped at 3000 ML
            const newIntake = Math.min(currentIntake + INCREMENT_ML, WATER_GOAL_ML);
            
            if (newIntake === currentIntake) {
                console.log("Water intake goal already met.");
                return;
            }
            
            const newWaterData = {
                dailyWaterIntake: newIntake,
                dailyWaterDate: todayDate,
            };

            try {
                await setDoc(streakRef, newWaterData, { merge: true });
                // The onSnapshot listener will update userState and trigger renderApp
            } catch (error) {
                console.error("Error updating water intake:", error);
            }
        };

        window.handleCompleteDay = async (dayIndexToComplete) => {
            if (!db || !userId) return;

            const todayDate = getTodayDateString();
            const streakRef = doc(db, 'artifacts', APP_ID, 'users', userId, 'completion_data', 'streak_stats');
            
            const todayIndex = new Date().getDay() === 0 ? 6 : new Date().getDay() - 1;
            const isCompletingToday = dayIndexToComplete === todayIndex;
            const isAlreadyComplete = userState.weeklyCompletion[dayIndexToComplete] === true;

            if (isAlreadyComplete) {
                console.log(`Day ${dayIndexToComplete} already marked complete.`);
                return;
            }

            let newStreakDays = userState.streakDays;
            let newLastCompletionDate = userState.lastCompletionDate;
            let newWeeklyCompletion = { ...userState.weeklyCompletion };
            
            if (isCompletingToday) {
                const lastDate = userState.lastCompletionDate;
                const diffDays = dateDifferenceInDays(lastDate, todayDate);
                
                // Streak logic: 
                // 1. If never completed OR completion was > 1 day ago -> start a new streak (1 day)
                // 2. If completion was exactly 1 day ago (yesterday) -> increment streak
                if (lastDate === null || diffDays > 1) {
                    newStreakDays = 1;
                } else if (diffDays === 1) {
                    newStreakDays += 1;
                }
                
                newLastCompletionDate = todayDate;
            }

            newWeeklyCompletion[dayIndexToComplete] = true;
            
            const newStreakData = {
                streakDays: newStreakDays,
                lastCompletionDate: newLastCompletionDate, 
                weeklyCompletion: newWeeklyCompletion,
            };
            
            try {
                await setDoc(streakRef, newStreakData, { merge: true });
                // The onSnapshot listener will update userState and trigger renderApp
            } catch (error) {
                console.error("Error updating completion data:", error);
            }
        };

        window.handleSaveProfile = async (e) => {
            e.preventDefault();
            
            const saveIcon = document.getElementById('save-icon');
            const saveText = document.getElementById('save-text');
            
            const startSaving = () => {
                if (saveIcon && saveText) {
                    saveIcon.innerHTML = `<svg class="animate-spin h-5 w-5 text-slate-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                    saveText.textContent = 'SYNCHRONIZING DATA...';
                }
                setProfileMessage(''); // Clear previous message
            };
            
            const stopSaving = (message, isError) => {
                if (saveIcon && saveText) {
                    saveIcon.innerHTML = icons.CheckCircle;
                    saveText.textContent = 'SAVE PROTOCOL';
                }
                setProfileMessage(message);
            };

            if (!db || !userId) {
                stopSaving("Error: Database connection not ready.", true);
                return;
            }
            startSaving();

            const profileRef = doc(db, 'artifacts', APP_ID, 'users', userId, 'user_profile', 'stats');
            
            const name = document.getElementById('profile-name').value;
            const height = document.getElementById('profile-height').value;
            const weight = document.getElementById('profile-weight').value;
            const age = document.getElementById('profile-age').value;
            const targetWeightChangeKg = document.getElementById('profile-target-change')?.value || 0;
            const goalDurationMonths = document.getElementById('profile-duration')?.value || 0;
            
            // --- UPDATED LOGIC FOR CHART HISTORY ---
            const currentWeight = weight ? parseFloat(weight) : 0;
            const todayDate = getTodayDateString();

            // Get existing history or init empty
            let existingHistory = userState.weightHistory || [];

            // Logic: If weight changed OR it's a new day with no entry, add to history.
            const lastEntry = existingHistory[existingHistory.length - 1];
            if (!lastEntry || (lastEntry.date !== todayDate && lastEntry.weight !== currentWeight)) {
                // If the dates are different, push new
                if (lastEntry && lastEntry.date !== todayDate) {
                     existingHistory.push({ date: todayDate, weight: currentWeight });
                } 
                // If it is the first entry
                else if (!lastEntry) {
                     existingHistory.push({ date: todayDate, weight: currentWeight });
                }
            } 
            
            // If it IS today, update the weight entry for today to correct typos
            if (lastEntry && lastEntry.date === todayDate) {
                lastEntry.weight = currentWeight;
            }
            
            const profileData = {
                name,
                height: height ? parseFloat(height) : '',
                weight: currentWeight,
                age: age ? parseInt(age, 10) : '',
                goal: userState.goal,
                goalDurationMonths: goalDurationMonths ? parseInt(goalDurationMonths, 10) : 0,
                targetWeightChangeKg: targetWeightChangeKg ? parseFloat(targetWeightChangeKg) : 0,
                weightHistory: existingHistory // Save the array to Firestore
            };

            try {
                await setDoc(profileRef, profileData, { merge: true });
                stopSaving('Profile saved successfully! Data sync complete.', false);
                // The onSnapshot listener updates userState
            } catch (error) {
                console.error("Error saving profile:", error);
                stopSaving('CRITICAL ERROR: Failed to save profile data.', true);
            }
        };

        window.handleGoogleSignIn = async () => {
            if (!auth || !auth.currentUser) return;
            
            setProfileMessage('Initiating Google sign-in protocol...');

            const provider = new GoogleAuthProvider();

            try {
                if (auth.currentUser.isAnonymous) {
                    // Upgrade Anonymous User
                    const result = await linkWithPopup(auth.currentUser, provider);
                    // Force the state update listener to fire
                    if (result && result.user) {
                        isAnonymousUser = false; 
                        setProfileMessage('Account successfully linked! Data secured.');
                    }
                } else {
                    // Standard Sign In/Sign Up
                    const result = await signInWithPopup(auth, provider);
                    // The onAuthStateChanged listener handles the rest
                    if (result && result.user) {
                        setProfileMessage('Sign-in complete. Welcome back!');
                    }
                }
            } catch (error) {
                console.error("Google Sign-In Failed:", error);
                let errorMessage = 'Google Sign-In Failed: Protocol error.';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign-in cancelled by user.';
                } else if (error.code === 'auth/credential-already-in-use') {
                    errorMessage = 'Error: That Google account is already linked to another profile.';
                }
                setProfileMessage(`ERROR: ${errorMessage}`);
            }
        };


        window.handleSendCoach = (e) => {
            e.preventDefault();
            const inputEl = document.getElementById('coach-input');
            const query = inputEl.value.trim();
            if (!query || coachState.isThinking) return;

            // REX FIX: Use global coachState
            
            // 1. Add user message
            const newMsg = { id: Date.now(), sender: 'user', text: query };
            coachState.messages.push(newMsg);
            
            // Clear input and set thinking state
            inputEl.value = '';
            coachState.isThinking = true;
            renderApp(); // Re-render to show user message and thinking state

            // 2. Simulate bot response
            setTimeout(() => {
                const response = getCoachResponse(newMsg.text, userState.goal); 
                coachState.messages.push({ id: Date.now() + 1, sender: 'bot', text: response });
                
                // 3. Update state and re-render
                coachState.isThinking = false;
                renderApp();
            }, 1000);
        };
        
        window.handleQuickAsk = (query) => {
            if (coachState.isThinking) return;
             
            // REX FIX: Use global coachState
            
            // 1. Add user quick ask message to global state
            const newMsg = { id: Date.now(), sender: 'user', text: query };
            coachState.messages.push(newMsg);
            
            // 2. Set thinking state and re-render
            coachState.isThinking = true;
            renderApp();
            
            // 3. Simulate bot response
            setTimeout(() => {
                const response = getCoachResponse(query, userState.goal);
                coachState.messages.push({ id: Date.now() + 1, sender: 'bot', text: response });
                
                // 4. Update state and re-render
                coachState.isThinking = false;
                renderApp();
            }, 1000);
        };


        // --- Firebase Core Logic ---

        const setupDataListeners = () => {
            if (!db || !userId || !isAuthReady) return;

            // 1. Profile Data Listener
            const profileRef = doc(db, 'artifacts', APP_ID, 'users', userId, 'user_profile', 'stats');
            onSnapshot(profileRef, (docSnap) => {
                const prevName = userState.name;
                const prevGoal = userState.goal;
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userState = { 
                        ...userState, 
                        name: data.name || '',
                        height: data.height || '', 
                        weight: data.weight || '',
                        age: data.age || '',
                        goal: data.goal || 'maintenance',
                        goalDurationMonths: data.goalDurationMonths || 0,
                        targetWeightChangeKg: data.targetWeightChangeKg || 0,
                        weightHistory: data.weightHistory || [], 
                    };
                }
                
                // REX FIX: Update initial chat message if name or goal changed and chat is empty
                if (coachState.messages.length <= 1 && (prevName !== userState.name || prevGoal !== userState.goal)) {
                    const initialMessage = `Access granted, ${userState.name || 'Athlete'}. I'm Coach Rex, your AI training matrix. Query your ${WORKOUT_PLANS[userState.goal]?.title || 'fitness'} protocol.`;
                    coachState.messages = [{ id: 1, sender: 'bot', text: initialMessage }];
                }
                
                renderApp();
            }, (error) => {
                console.error("Error fetching Profile data:", error);
            });

            // 2. Streak/Completion Data Listener
            const streakRef = doc(db, 'artifacts', APP_ID, 'users', userId, 'completion_data', 'streak_stats');
            onSnapshot(streakRef, (docSnap) => {
                const today = getTodayDateString();
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    let intake = data.dailyWaterIntake || 0;
                    let intakeDate = data.dailyWaterDate || null;
                    
                    // Daily Reset Logic for Water Intake
                    if (intakeDate !== today) {
                        if (intakeDate !== null) {
                            intake = 0; // Reset for a new day
                        }
                    }

                    userState = {
                        ...userState,
                        streakDays: data.streakDays || 0,
                        lastCompletionDate: data.lastCompletionDate || null,
                        weeklyCompletion: data.weeklyCompletion || {},
                        dailyWaterIntake: intake, 
                        dailyWaterDate: today,
                    };
                } else {
                    // Initialize water intake date for new/empty doc
                    userState = {
                        ...userState,
                        dailyWaterIntake: 0,
                        dailyWaterDate: today,
                    };
                }
                renderApp();
            }, (error) => {
                console.error("Error fetching Streak data:", error);
            });
        };

        const initFirebaseAndAuth = async () => {
            try {
                app = initializeApp(FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                isAuthReady = true;
                renderApp();
                return;
            }
            
            // REX FIX: Set up initial chat message immediately for a quick visual feedback
            const initialMessage = `Access granted, Athlete. I'm Coach Rex, your AI training matrix. Query your fitness protocol.`;
            coachState.messages = [{ id: 1, sender: 'bot', text: initialMessage }];

            // Set up Auth State Listener
            onAuthStateChanged(auth, (currentUser) => {
                if (currentUser) {
                    userId = currentUser.uid;
                    // Check if user is anonymous
                    isAnonymousUser = currentUser.isAnonymous; 
                } else {
                    userId = null; 
                    isAnonymousUser = false;
                }
                isAuthReady = true;
                renderApp();
                setupDataListeners();
            });

            // Attempt Sign-In
            try {
                if (INITIAL_AUTH_TOKEN) {
                    await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
            }
        };

        // Start the application after the script loads
        initFirebaseAndAuth();

    </script>
</body>
</html>

